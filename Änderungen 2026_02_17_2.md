# Änderungen vom 17.02.2026 (Teil 2)

## Übersicht der bearbeiteten Dateien

1. `functions.php` – Neue Funktionen: logAuditAction(), erweiterte Berechtigungen, Berechtigungsgruppen-Funktionen
2. `index.php` – Navigation erweitert, Seitenrouting für neue Seiten, Mobile-Overlay, Audit-Logging in Auto-Zuteilung/QR-Generierung
3. `login.php` – Audit-Logging bei Benutzer-Login
4. `logout.php` – Audit-Logging bei Benutzer-Logout
5. `setup.php` – Neue Migrationen: audit_logs, permission_groups, permission_group_items Tabellen
6. `migrations.sql` – SQL-Definitionen für neue Tabellen (audit_logs, permission_groups, permission_group_items)
7. `pages/admin-audit-logs.php` – Neue Seite: Audit-Log-Ansicht mit Filtern und Pagination
8. `pages/admin-permissions.php` – Berechtigungsgruppen-UI: erstellen, löschen, anwenden, erweiterte Berechtigungen
9. `pages/admin-qr-codes.php` – Anwesenheitsliste: klickbare Statistik, Detailmodal, Übersicht
10. `pages/teacher-dashboard.php` – "Letzte Anmeldungen" entfernt, Tipps aktualisiert
11. `pages/schedule.php` – Mobile-optimierte Buttons (Icons-Only auf kleinen Displays)

---

## Detaillierte Änderungen

### Issue #21: Audit Logs hinzufügen

**Anforderung:**
- Logs für Aktionen von allen Nutzern bei jeglichen Aktionen (filterbar)
- Nur für Admins einsehbar und nicht durch diese editierbar
- Format: Zeitpunkt, Nutzer, Aktion

**Lösung:**

#### Datenbank
- Neue Tabelle `audit_logs` mit Spalten: id, user_id, username, action, details, ip_address, created_at
- Indizes auf user_id, action und created_at für schnelle Filterung

#### Backend (functions.php)
- Neue Funktion `logAuditAction($action, $details)` – schreibt Audit-Einträge mit Benutzer-ID, Benutzername, IP-Adresse und Zeitstempel
- Fehlertolerante Implementierung (Fehler werden geloggt, blockieren aber nicht den Ablauf)

#### Logging-Integration
- **Login** (login.php): Protokolliert erfolgreiche Anmeldungen
- **Logout** (logout.php): Protokolliert Abmeldungen
- **Auto-Zuteilung** (index.php): Protokolliert Anzahl der Zuweisungen und verbleibende Schüler
- **QR-Code Generierung** (index.php): Protokolliert Massengenerierung mit Anzahl
- **Berechtigungsänderungen** (admin-permissions.php): Protokolliert welche Berechtigungen geändert wurden

#### Admin-Seite (pages/admin-audit-logs.php)
- Filterbare Tabelle: nach Benutzer, Aktion und Datum
- Pagination (50 Einträge pro Seite)
- Statistik-Karten: Gesamteinträge, aktuelle Seite, Aktionstypen
- Schreibgeschützt – keine Bearbeitungs- oder Löschfunktion
- Hinweisbox über die Unveränderbarkeit der Logs

#### Navigation
- Neuer Menüeintrag "Audit Logs" im Admin-Bereich
- Route `admin-audit-logs` im Seitenrouting

**Geänderte Dateien:** functions.php, index.php, login.php, logout.php, setup.php, migrations.sql, pages/admin-audit-logs.php

---

### Issue #22: Lehrer komplett überarbeiten

**Anforderung:**
- Mehr Berechtigungsoptionen für Lehrer
- Einsicht in Raumplan
- Tour neugestalten
- Zugriff auf Druckerzentrale
- Letzte Anmeldungen entfernen

**Lösung:**

#### Berechtigungsoptionen
- Neue Berechtigung `view_rooms` – Raumplan einsehen
- Lehrer können über das Berechtigungssystem gezielt Zugriff auf Funktionen erhalten
- Voreingestellte Berechtigungsgruppe "Lehrer Standard" mit view_reports und view_rooms

#### Navigation (index.php)
- Lehrer-Seitenleiste erweitert um:
  - "Raumplan" (wenn `view_rooms` Berechtigung vorhanden)
  - "Druckzentrale" (wenn `view_reports` Berechtigung vorhanden)
- Seitenrouting erlaubt Lehrern mit `view_rooms` Zugriff auf admin-rooms

#### Teacher-Dashboard (teacher-dashboard.php)
- "Letzte Anmeldungen" Sektion komplett entfernt
- Tipps-Box aktualisiert mit Hinweisen auf Druckzentrale und Raumplan
- Fokus auf Klassenübersicht und Statistiken

**Geänderte Dateien:** index.php, pages/teacher-dashboard.php, functions.php

---

### Issue #24: Mobile Ansicht (Schüler)

**Anforderung:**
- Hamburger Menü für Seitenleiste
- "Schließen"-Button bei Ausstellerbeschreibung mit mehr Abstand zum unteren Rand
- Tagesplan mit Buttons → nur Icons bei kleinen Displays
- Allgemein: Buttons mit Text und Icon sollen bei Mobile nur das Icon anzeigen

**Lösung:**

#### Hamburger Menü (index.php)
- Dunkles Overlay (`mobileOverlay`) wird beim Öffnen der Seitenleiste angezeigt
- Klick auf das Overlay schließt die Seitenleiste
- Sanfte Animation mit opacity-Transition
- Neues JavaScript mit `openMobileSidebar()` und `closeMobileSidebar()` Funktionen

#### Ausstellerbeschreibung (index.php CSS)
- Modal-Footer mit erhöhtem `padding-bottom` (1.5rem Desktop, 2rem Mobile)
- Berücksichtigung von `safe-area-inset-bottom` für iOS-Geräte
- Modal-Höhe auf 85vh begrenzt mit 2rem Abstand zum unteren Rand

#### Tagesplan & Buttons (index.php CSS, schedule.php)
- CSS-Klasse `btn-mobile-icon`: versteckt Text (`span.btn-text`) auf Displays < 768px
- PDF-Download-Button im Tagesplan nutzt diese Klasse
- Generelle Regel: `.schedule-actions` Buttons zeigen auf Mobile nur Icons

**Geänderte Dateien:** index.php, pages/schedule.php

---

### Issue #26: Berechtigungs-Rework

**Anforderung:**
- Alle Aktionen sollen eigene Berechtigungen haben (namentlich identifizierbar, nach Seite geordnet)
- Berechtigungsgruppen von Admins erstellbar, vergebbar an Orga
- Voreingestellte Berechtigungen

**Lösung:**

#### Erweiterte Berechtigungen (functions.php)
- Berechtigungsliste erweitert von 6 auf 9 Berechtigungen:
  - `manage_exhibitors` – Ausstellerverwaltung
  - `manage_rooms` – Raumverwaltung
  - `manage_settings` – Systemeinstellungen
  - `manage_users` – Benutzerverwaltung
  - `view_reports` – Berichte & Druckzentrale
  - `auto_assign` – Automatische Zuteilung
  - **NEU:** `view_rooms` – Raumplan einsehen
  - **NEU:** `manage_qr_codes` – QR-Code Verwaltung
  - **NEU:** `view_audit_logs` – Audit Logs einsehen

#### Berechtigungsgruppen (Datenbank)
- Neue Tabelle `permission_groups` (id, name, description, created_by, created_at)
- Neue Tabelle `permission_group_items` (id, group_id, permission)
- Voreingestellte Gruppen:
  - **Lehrer Standard** – view_reports, view_rooms
  - **Orga-Team** – manage_exhibitors, manage_rooms, view_reports, view_rooms, manage_qr_codes
  - **Vollzugriff** – Alle 9 Berechtigungen

#### Backend-Funktionen (functions.php)
- `getPermissionGroups()` – Alle Gruppen laden
- `getPermissionGroupPermissions($groupId)` – Berechtigungen einer Gruppe laden
- `applyPermissionGroup($userId, $groupId)` – Gruppe auf Benutzer anwenden

#### Admin-UI (admin-permissions.php)
- Berechtigungsgruppen-Sektion mit Übersicht aller Gruppen und deren Berechtigungen
- "Neue Gruppe" Button mit Modal zum Erstellen (Name, Beschreibung, Berechtigungen auswählen)
- Gruppen löschen mit Bestätigung
- Quick-Apply: Dropdown neben jedem Benutzer zum schnellen Anwenden einer Gruppe
- Alle Aktionen werden im Audit Log protokolliert

**Geänderte Dateien:** functions.php, setup.php, migrations.sql, pages/admin-permissions.php

---

### Issue #27: Anwesenheit

**Anforderung:**
- Option um alle anwesenden (QR Code bestätigt) für Admins im QR-Code Hub anzeigen
- Bei Klick auf x/x anwesend → Details anzeigen

**Lösung:**

#### Anwesenheitsübersicht (admin-qr-codes.php)
- Neue Übersichts-Sektion mit Gesamt-Statistik:
  - Anzahl eingecheckter Schüler
  - Gesamtanzahl Check-ins
- Detaillierte Anwesenheitsdaten werden beim Seitenaufruf geladen

#### Klickbare Statistik
- "x/x anwesend" Anzeige bei jedem Aussteller/Slot ist jetzt ein klickbarer Button
- Grünes Styling wenn Anwesende vorhanden, graues wenn noch niemand eingecheckt
- Icon `fa-users` zur visuellen Kennzeichnung

#### Anwesenheits-Modal
- Popup-Modal zeigt Detailliste beim Klick auf den Anwesenheits-Button
- Tabelle mit: Nr., Name (Vor-/Nachname), Klasse, Check-in-Zeit
- Titel zeigt Aussteller und Zeitslot
- Zähler-Badge mit Gesamtanzahl Anwesender
- Leerzustand wenn noch niemand eingecheckt
- Schließen über X-Button, Hintergrund-Klick oder Escape-Taste

**Geänderte Dateien:** pages/admin-qr-codes.php

---

## Zusammenfassung

### Bearbeitete Issues:
✅ Issue #21: Audit Logs hinzufügen (high priority)
✅ Issue #22: Lehrer komplett überarbeiten (low priority)
✅ Issue #24: Mobile Ansicht Schüler (high priority)
✅ Issue #26: Berechtigungs-Rework (high priority)
✅ Issue #27: Anwesenheit (enhancement)

### Neue Dateien:
- `pages/admin-audit-logs.php` – Audit-Log-Verwaltungsseite

### Neue Datenbanktabellen:
- `audit_logs` – Protokollierung aller Nutzeraktionen
- `permission_groups` – Berechtigungsgruppen-Definitionen
- `permission_group_items` – Berechtigungen innerhalb von Gruppen

### Neue Berechtigungen:
- `view_rooms` – Raumplan einsehen
- `manage_qr_codes` – QR-Code Verwaltung
- `view_audit_logs` – Audit Logs einsehen

### Neue Funktionen:
- `logAuditAction()` – Audit-Log-Eintrag schreiben
- `getPermissionGroups()` – Berechtigungsgruppen abrufen
- `getPermissionGroupPermissions()` – Gruppen-Berechtigungen abrufen
- `applyPermissionGroup()` – Gruppe auf Benutzer anwenden

---

## Sicherheitsaspekte

### XSS-Schutz
✅ Alle Benutzereingaben mit `htmlspecialchars()` escaped
✅ JSON-Daten in Attributen korrekt encodiert
✅ `escapeHtml()` JavaScript-Funktion für dynamische Inhalte

### SQL-Injection
✅ Prepared Statements in allen neuen Datenbankabfragen
✅ `intval()` für numerische Parameter

### Audit Logs
✅ Schreibgeschützt – keine DELETE/UPDATE API vorhanden
✅ IP-Adressen werden protokolliert
✅ Fehlertolerante Implementierung

### Berechtigungssystem
✅ Alle neuen Seiten prüfen Berechtigungen
✅ Admins haben automatisch alle Berechtigungen
✅ Berechtigungsänderungen werden im Audit Log protokolliert

---

**Autor:** Claude (GitHub Copilot Agent)  
**Datum:** 17.02.2026  
**Branch:** copilot/update-issues-documentation
